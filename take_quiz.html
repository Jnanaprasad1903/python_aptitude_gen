<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        .container { max-width: 600px; margin: auto; }
        .question { margin: 20px 0; }
        input[type="radio"] { margin: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #timer { font-size: 24px; color: red; }
        #countdown { font-size: 48px; color: green; }
        .results { text-align: left; }
        .error { color: red; }
    </style>
    <script>
        // Convert Jinja variables to safe JS variables
        let currentQuestion = 0;
        let timePerQuestion = Number("{{ quiz.per_question_time | default(0) }}");
        let numQuestions = Number("{{ quiz.num_questions | default(0) }}");
        let questions = JSON.parse(`{{ quiz.questions | tojson | safe }}`);
        const hasResults = "{{ 'true' if results else 'false' }}" === "true";
 
        let timer;
        let answers = {};

        function startCountdown() {
            let countdown = 3;
            document.getElementById('countdown').innerText = countdown;
            let countdownInterval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    document.getElementById('countdown').innerText = countdown;
                } else {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').style.display = 'none';
                    document.getElementById('quiz-content').style.display = 'block';
                    startQuestionTimer();
                    showQuestion();
                }
            }, 1000);
        }

        function startQuestionTimer() {
            let timeLeft = timePerQuestion;
            document.getElementById('timer').innerText = `Time Left: ${timeLeft}s`;
            timer = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    document.getElementById('timer').innerText = `Time Left: ${timeLeft}s`;
                } else {
                    clearInterval(timer);
                    saveAnswer();
                    nextQuestion();
                }
            }, 1000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showQuestion() {
            if (!questions || currentQuestion >= questions.length) {
                submitQuiz();
                return;
            }
            const q = questions[currentQuestion];
            document.getElementById('question-text').innerText = q.question || 'Question not available';
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            (q.options || []).forEach((option, index) => {
                const escapedOption = escapeHtml(option);
                optionsDiv.innerHTML += `
                    <input type="radio" name="question_${currentQuestion}" value="${escapedOption}" id="option_${index}">
                    <label for="option_${index}">${escapedOption}</label><br>
                `;
            });
        }

        function saveAnswer() {
            const selectedOption = document.querySelector(`input[name="question_${currentQuestion}"]:checked`);
            answers[`question_${currentQuestion}`] = selectedOption ? selectedOption.value : null;
        }

        function nextQuestion() {
            clearInterval(timer);
            saveAnswer();
            currentQuestion++;
            if (currentQuestion < numQuestions) {
                startQuestionTimer();
                showQuestion();
            } else {
                submitQuiz();
            }
        }

        function submitQuiz() {
            const form = document.getElementById('quiz-form');
            for (const [key, value] of Object.entries(answers)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value || '';
                form.appendChild(input);
            }
            form.submit();
        }

        // No more Jinja tags inside JS -> no VS Code errors
        window.onload = function() {
            if (!hasResults) {
                if (numQuestions > 0 && timePerQuestion > 0) {
                    startCountdown();
                } else {
                    document.getElementById('quiz-content').innerHTML = '<p class="error">Invalid quiz configuration.</p>';
                }
            }
        };
    </script>
</head>
<body>
    <div class="container">
        {% if results %}
            <h2>Quiz Results: {{ quiz.quiz_name | default('Unnamed Quiz') }}</h2>
            <p>Score: {{ score | default(0) }} / {{ quiz.num_questions | default(0) }}</p>
            <div class="results">
                {% for result in results %}
                    <p><strong>Question:</strong> {{ result.question | default('N/A') }}</p>
                    <p><strong>Your Answer:</strong> {{ result.user_answer | default('Skipped') }}</p>
                    <p><strong>Correct Answer:</strong> {{ result.correct_answer | default('N/A') }}</p>
                    <p><strong>Explanation:</strong> {{ result.explanation | default('No explanation available') }}</p>
                    <p><strong>Correct:</strong> {{ 'Yes' if result.correct else 'No' }}</p>
                    <hr>
                {% endfor %}
            </div>
            <a href="/dashboard">Back to Dashboard</a>
        {% else %}
            <h2>{{ quiz.quiz_name | default('Unnamed Quiz') }}</h2>
            <div id="countdown"></div>
            <div id="quiz-content" style="display: none;">
                <p id="timer"></p>
                <form id="quiz-form" method="POST">
                    <div class="question" id="question-text"></div>
                    <div id="options"></div>
                    <button type="button" onclick="nextQuestion()">Next</button>
                </form>
            </div>
        {% endif %}
    </div>
</body>
</html>
